# 一人暮らし費用計算アプリ 開発手順書

# 開発手順書 v1.0 - コード品質向上編

## 📋 目次

1. [定数の定義（マジックナンバーの解消）](#定数の定義)
2. [ログ出力の追加](#ログ出力の追加)
3. [例外処理の改善](#例外処理の改善)
4. [ページネーション機能](#ページネーション機能)

---

## 定数の定義

### 目的

計算式に直接書かれている数値（マジックナンバー）を定数として定義し、コードの可読性と保守性を向上させる

### 実装場所

- `LivingCostService.java` に定数クラスを作成、またはクラス内に定数フィールドを定義

### ヒント

- `private static final` を使用
- 定数名は意味が分かりやすい名前にする（例：`MAX_RENT_RATE`、`UTILITIES_RATE`）
- パーセンテージは小数で定義（例：`0.25`）または整数で定義（例：`25`）して計算時に変換
- 定数クラスを作る場合は `Constants` や `LivingCostConstants` などの名前

### 定義すべき定数

- 家賃上限率（25%）
- 光熱費率（家賃の12%）
- 食費率（年収の12%）
- その他率（年収の5%）
- 通信費（4000円）

---

## ログ出力の追加

### 目的

アプリケーションの動作を追跡し、問題発生時の原因特定を容易にする

### 実装場所

- `CalculationHistoryKensakuRepository.java`
- `LivingCostService.java`
- `LivingCostController.java`

### ヒント

- `Logger` と `LoggerFactory` を使用（SLF4J）
- ログレベルを適切に使い分ける
  - `DEBUG`: 詳細な情報（開発時のみ）
  - `INFO`: 一般的な情報（処理開始、終了など）
  - `WARN`: 警告（想定内のエラー）
  - `ERROR`: エラー（想定外のエラー）
- ログに出力する情報
  - 検索条件（パラメータ値）
  - 検索結果件数
  - エラー発生時の詳細情報（スタックトレース）
  - 処理時間（パフォーマンス計測）

### ログ出力例（ヒント）

```java
// Loggerの取得
private static final Logger logger = LoggerFactory.getLogger(クラス名.class);

// ログ出力
logger.info("検索開始: user={}, postalCode={}", user, postalCode);
logger.debug("SQL: {}", sql.toString());
logger.warn("検索結果が0件でした");
logger.error("エラー発生", exception);
```

---

## 例外処理の改善

### 目的

適切な例外処理により、エラー時の動作を明確にし、ユーザーに分かりやすいエラーメッセージを表示する

### 実装場所

- `exception` パッケージを作成
- `@ControllerAdvice` を使用したグローバル例外ハンドラー

### ヒント

#### 1. カスタム例外クラスの作成

- `RuntimeException` を継承
- 例外クラス名は `〜Exception` で終わる
- 例：`UserNotFoundException`、`PostalCodeNotFoundException`、`InvalidParameterException`

#### 2. グローバル例外ハンドラーの作成

- `@ControllerAdvice` アノテーションを使用
- `@ExceptionHandler` で例外タイプごとの処理を定義
- エラーページへのリダイレクトまたはエラーメッセージの表示

#### 3. 既存コードの修正

- `IllegalArgumentException` をcatchして何もしない箇所を修正
- 適切なカスタム例外をthrow
- Service層で例外をthrowし、Controller層でcatchしない（グローバルハンドラーに任せる）

### 実装の流れ（ヒント）

1. `exception` パッケージを作成
2. カスタム例外クラスを3つ程度作成
3. `GlobalExceptionHandler` クラスを作成（`@ControllerAdvice`）
4. 既存のtry-catchを修正

---

## ページネーション機能

### 目的

大量のデータを効率的に表示し、ユーザー体験を向上させる

### 実装場所

- `CalculationHistoryKensakuRepository.java` - 検索メソッドの修正
- `LivingCostController.java` - コントローラーメソッドの修正
- `history.html` - 画面の修正

### ヒント

#### 1. Repository層の修正

- 検索メソッドに `Pageable` パラメータを追加
- ネイティブSQLに `LIMIT` と `OFFSET` を追加
- 総件数を取得するメソッドも追加（COUNTクエリ）

#### 2. Service層の修正（必要に応じて）

- `Pageable` を受け取り、Repositoryに渡す
- `Page<CalculationHistory>` を返す

#### 3. Controller層の修正

- `@RequestParam` でページ番号を受け取る（デフォルト値：0）
- `PageRequest.of(page, size)` で `Pageable` を作成
- `Page` オブジェクトをModelに追加

#### 4. 画面の修正

- ThymeleafでページネーションUIを実装
- 前へ/次へボタン、ページ番号の表示
- `th:each` でページ番号をループ表示

### 使用するクラス・アノテーション（ヒント）

- `org.springframework.data.domain.Pageable`
- `org.springframework.data.domain.Page`
- `org.springframework.data.domain.PageRequest`
- Thymeleafの `th:each`、`th:href`、条件分岐

### 実装の流れ（ヒント）

1. Repositoryの検索メソッドに `Pageable` パラメータを追加
2. SQLに `LIMIT` と `OFFSET` を動的に追加
3. 総件数取得用のメソッドを追加
4. Controllerで `Pageable` を作成してRepositoryに渡す
5. 画面にページネーションUIを追加

---

## 実装の優先順位

1. **定数の定義** - 最も簡単で効果が大きい
2. **ログ出力の追加** - デバッグに役立つ
3. **例外処理の改善** - コード品質の向上
4. **ページネーション機能** - ユーザー体験の向上

---

## 参考資料

- Spring Boot公式ドキュメント: https://spring.io/projects/spring-boot
- SLF4J公式ドキュメント: http://www.slf4j.org/
- Spring Data JPA公式ドキュメント: https://spring.io/projects/spring-data-jpa
- Thymeleaf公式ドキュメント: https://www.thymeleaf.org/
