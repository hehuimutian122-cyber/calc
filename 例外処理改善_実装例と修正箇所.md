# ä¾‹å¤–å‡¦ç†ã®æ”¹å–„ - å®Ÿè£…ä¾‹ã¨ä¿®æ­£ç®‡æ‰€

## ğŸ“‹ å®Ÿè£…ä¾‹

### 1. ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã®ä½œæˆ

æ—¢ã«ä»¥ä¸‹ã®ä¾‹å¤–ã‚¯ãƒ©ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã™ï¼š
- `UserNotFoundException` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
- `PostalCodeNotFoundException` - éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
- `InvalidParameterException` - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸æ­£ãªå ´åˆ
- `UserAlreadyExistsException` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆï¼ˆæ–°è¦è¿½åŠ ï¼‰
- `PasswordMismatchException` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„å ´åˆï¼ˆæ–°è¦è¿½åŠ ï¼‰

### 2. Serviceå±¤ã§ã®ä¾‹å¤–ã®throw

**ä¿®æ­£å‰ï¼ˆUserService.javaï¼‰:**
```java
public User findByUsername(String username) {
    return userRepository.findByUsername(username)
            .orElseThrow(() -> new IllegalArgumentException("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + username));
}
```

**ä¿®æ­£å¾Œ:**
```java
public User findByUsername(String username) {
    return userRepository.findByUsername(username)
            .orElseThrow(() -> new UserNotFoundException("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + username));
}
```

**ä¿®æ­£å‰ï¼ˆUserService.java - registerNewUserï¼‰:**
```java
if (userRepository.existsByUsername(registrationDto.getUsername())) {
    throw new IllegalArgumentException("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™");
}
```

**ä¿®æ­£å¾Œ:**
```java
if (userRepository.existsByUsername(registrationDto.getUsername())) {
    throw new UserAlreadyExistsException("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™");
}
```

### 3. Controllerå±¤ã§ã®ä¾‹å¤–å‡¦ç†ã®å‰Šé™¤

**ä¿®æ­£å‰ï¼ˆLivingCostController.javaï¼‰:**
```java
try {
    currentUser = userService.findByUsername(username);
    logger.debug("ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ");
} catch (IllegalArgumentException e) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯nullã®ã¾ã¾
    logger.warn("ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—å¤±æ•—: {}", e.getMessage());
}
```

**ä¿®æ­£å¾Œ:**
```java
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯UserNotFoundExceptionãŒã‚¹ãƒ­ãƒ¼ã•ã‚Œã€
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§å‡¦ç†ã•ã‚Œã‚‹
currentUser = userService.findByUsername(username);
logger.debug("ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—æˆåŠŸ");
```

### 4. ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ‹¡å¼µ

**GlobalExceptionHandler.java ã«è¿½åŠ :**
```java
/**
 * IllegalArgumentExceptionã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
 * ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã«ç§»è¡Œã™ã‚‹ã¾ã§ã®æš«å®šå¯¾å¿œã¨ã—ã¦è¿½åŠ 
 */
@ExceptionHandler(IllegalArgumentException.class)
public String handleIllegalArgumentException(IllegalArgumentException e, Model model) {
    logger.error("ä¸æ­£ãªå¼•æ•°ãŒæ¸¡ã•ã‚Œã¾ã—ãŸ: {}" , e.getMessage(), e);
    model.addAttribute("errorMessage", e.getMessage());
    return "error/invalid-parameter";
}

/**
 * UserAlreadyExistsExceptionã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
 */
@ExceptionHandler(UserAlreadyExistsException.class)
public String handleUserAlreadyExistsException(UserAlreadyExistsException e, Model model) {
    logger.warn("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™: {}" , e.getMessage());
    model.addAttribute("errorMessage", e.getMessage());
    return "error/user-already-exists";
}

/**
 * PasswordMismatchExceptionã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
 */
@ExceptionHandler(PasswordMismatchException.class)
public String handlePasswordMismatchException(PasswordMismatchException e, Model model) {
    logger.warn("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“: {}" , e.getMessage());
    model.addAttribute("errorMessage", e.getMessage());
    return "error/password-mismatch";
}
```

### 5. Controllerå†…ã®@ExceptionHandlerï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼‰

**AuthController.java ã«è¿½åŠ :**
```java
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ™‚ã®ä¾‹å¤–å‡¦ç†
 * ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŸã‚ã€Controllerå†…ã§å‡¦ç†
 */
@ExceptionHandler({UserAlreadyExistsException.class, PasswordMismatchException.class})
public String handleRegistrationException(RuntimeException e, 
                                           @ModelAttribute("userRegistrationDto") UserRegistrationDto registrationDto,
                                           BindingResult result) {
    // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤º
    result.rejectValue("username", "error.userRegistrationDto", e.getMessage());
    return "register";
}
```

---

## âœ… ä¿®æ­£å®Œäº†ç®‡æ‰€

### 1. **UserService.java**
- âœ… `findByUsername`ãƒ¡ã‚½ãƒƒãƒ‰: `IllegalArgumentException` â†’ `UserNotFoundException`ã«å¤‰æ›´
- âœ… `registerNewUser`ãƒ¡ã‚½ãƒƒãƒ‰: `IllegalArgumentException` â†’ `UserAlreadyExistsException`ã€`PasswordMismatchException`ã«å¤‰æ›´

### 2. **LivingCostController.java**
- âœ… `calculate`ãƒ¡ã‚½ãƒƒãƒ‰: `IllegalArgumentException`ã®catchãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«å§”è­²

### 3. **AuthController.java**
- âœ… `registerUser`ãƒ¡ã‚½ãƒƒãƒ‰: `IllegalArgumentException`ã®catchãƒ–ãƒ­ãƒƒã‚¯ã‚’å‰Šé™¤
- âœ… `@ExceptionHandler`ã‚’è¿½åŠ ã—ã¦ã€ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤º

### 4. **GlobalExceptionHandler.java**
- âœ… `IllegalArgumentException`ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ ï¼ˆæš«å®šå¯¾å¿œï¼‰
- âœ… `UserAlreadyExistsException`ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
- âœ… `PasswordMismatchException`ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 

### 5. **æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«**
- âœ… `UserAlreadyExistsException.java` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ä¾‹å¤–
- âœ… `PasswordMismatchException.java` - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ãªã„å ´åˆã®ä¾‹å¤–

---

## ğŸ” ä»Šå¾Œã®æ”¹å–„å€™è£œç®‡æ‰€

### 1. **PostalCodeService.java**
ç¾åœ¨ã€éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯`null`ã‚’è¿”ã—ã¦ã„ã¾ã™ãŒã€`PostalCodeNotFoundException`ã‚’throwã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚æ¤œè¨ã§ãã¾ã™ã€‚

**ç¾çŠ¶:**
```java
if (zipCloudResponse.getResults() == null || 
    zipCloudResponse.getResults().isEmpty()) {
    logger.warn("éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: {}", postalCode);
    return null;  // nullã‚’è¿”ã—ã¦ã„ã‚‹
}
```

**æ”¹å–„æ¡ˆ:**
```java
if (zipCloudResponse.getResults() == null || 
    zipCloudResponse.getResults().isEmpty()) {
    throw new PostalCodeNotFoundException("éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: " + postalCode);
}
```

### 2. **LivingCostService.java**
`PostalCodeService.getPrefectureName`ãŒ`null`ã‚’è¿”ã—ãŸå ´åˆã®å‡¦ç†ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¾‹å¤–ã‚’throwã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã§ãã¾ã™ã€‚

### 3. **ãã®ä»–ã®Serviceå±¤**
ä»–ã®Serviceã‚¯ãƒ©ã‚¹ã§`IllegalArgumentException`ã‚„ä¸€èˆ¬çš„ãªä¾‹å¤–ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Œã°ã€é©åˆ‡ãªã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã«ç½®ãæ›ãˆã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

---

## ğŸ“ å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

1. **Serviceå±¤ã§ä¾‹å¤–ã‚’throw**: Serviceå±¤ã§é©åˆ‡ãªã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚’throwã—ã€Controllerå±¤ã§ã¯catchã—ãªã„
2. **ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§å‡¦ç†**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã®ä¾‹å¤–ã‚’`@ControllerAdvice`ã§ä¸€å…ƒçš„ã«å‡¦ç†
3. **Controllerå†…ã®@ExceptionHandler**: ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€Controllerå†…ã«`@ExceptionHandler`ã‚’è¿½åŠ 
4. **ãƒ­ã‚°å‡ºåŠ›**: ä¾‹å¤–ç™ºç”Ÿæ™‚ã¯é©åˆ‡ãªãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã§ãƒ­ã‚°ã‚’å‡ºåŠ›ï¼ˆERRORã€WARNãªã©ï¼‰
5. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„å†…å®¹ã«ã™ã‚‹

---

## ğŸ¯ å®Ÿè£…ã®åŠ¹æœ

- âœ… ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š: ä¾‹å¤–ã®ç¨®é¡ãŒæ˜ç¢ºã«ãªã‚Šã€ã‚³ãƒ¼ãƒ‰ã®æ„å›³ãŒåˆ†ã‹ã‚Šã‚„ã™ããªã‚‹
- âœ… ä¿å®ˆæ€§å‘ä¸Š: ä¾‹å¤–å‡¦ç†ãŒä¸€ç®‡æ‰€ã«é›†ç´„ã•ã‚Œã€ä¿®æ­£ãŒå®¹æ˜“ã«ãªã‚‹
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã§ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒå¯èƒ½
- âœ… ãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“åŒ–: é©åˆ‡ãªãƒ­ã‚°å‡ºåŠ›ã«ã‚ˆã‚Šã€å•é¡Œã®åŸå› ç‰¹å®šãŒå®¹æ˜“ã«ãªã‚‹

